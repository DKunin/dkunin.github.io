<!DOCTYPE html>
<html>
  <head>
    <title>Immutable data</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <style type="text/css">

      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { 
        font-family: 'PT Sans'; 
        font-size: 26px;
      }
      h1, h2, h3 {
        font-size: 48px;
        font-weight: bold;
      }
      .remark-code, .remark-inline-code { 
        font-family: 'Ubuntu Mono', Monospace; 
      }
      .red {
        color: red;
      }
      .remark-slide-content {
        font-size: 45px;
        padding: .5em;
      }
      .remark-slide-content h3 {
        font-size: 1.2em;

      }

      .remark-code {
        font-size: 28px
      }
      .no-bullets ul{
        list-style: none;
        padding: 0;
        margin: 0;        
      }
      .no-bullets ul a{
        text-decoration: none;
        color: black;     
      }      
      .side {
        width: 48%;
        float: left;
        margin-right: 2%;
        font-size: 20px;
        display: inline-block;
      }
      .side .remark-code {
        font-size: 19px;
        text-align: left;
      }
      .image img {
        max-width: 80%;
        max-height: 100%;
      }
      .nopages .remark-slide-number{
        display: none;

      }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle, nopages

# Immutable Data
.subtitle[Неизменяемые данные в приложении: .red[что, зачем и как]]

.author[Дмитрий Кунин, AT-Consulting]

---

### План

* Что это такое
* Зачем это использовать
* Как это использовать

---

### .red[Что] это такое?


--
## Immutable

--
## Persistant 

---

### Принцип работы

Вместо мутирования существующего значения - каждый раз создается новый объект

    var list = I.List.of(1,2,3);
    var list2 = list.push(4);

    console.log(list.toJS()) // 1,2,3
    console.log(list === list2) // false


---

### Принцип работы

Создается глубокая копия объекта - клон меняется и возвращается

    List.prototype.push = function(value){
      // Делаем клон
      var clone = deepCopy(this);
      // Меняем значение в клоне
      clone[clone.length] = value;
      // Вовзращаем клон
      return clone;  
    }
---
class: center, middle

### Скорость работы

.side[

vanilla

    var list = [];
    for(var i=0;i < 1000000;i++) {
      list.push(i);
    }

# 83 ms
]
.side[

mori

    var list = mori.vector();
    for (var i=0; i < 1000000; i++) {
      mori.conj(list, i);
    }

# 288 ms
]

---
class: center, middle

### Направленный ациклический граф

.image[![](dag-1.jpg)]

---

class: center, middle
.image[![](dag-2.jpg)]

---
class: center, middle
.image[![](dag-3.jpg)]

---
class: center, middle

.image[![](dag-4.jpg)]

---
class: center, middle

.image[![](dag-5.jpg)]

---
class: center, middle

.image[![](dag-6.jpg)]


---

### Готовые библиотеки

* immutable.js
* mori
* seamless-immutable
* immutato
* pim
* seti
* texo
* ancient-oak

---

class: center, middle
name: why

# Зачем использовать?

---

template: why

# .red[Решать проблемы!]

---

# Мутирующие объекты могут мутировать :)))

    var identity = 'Someone';
        identity = 'Someone else';
        identity = 'Third person';

---

class: center, middle

# Интерфейс .red[должен] следить за изменениями

---

### Слушатели событий
    
    var data = {a: 1,b:2,c:3};

    Object.observe(data, function(changes){
      rerenderUI();
    });

    data.a = 10;
    data.b = 20;
    data.c = 30;

---

class: middle

# 

    var data = { ... };
    Object.observe(data, ... );
    data.foo.bar.a = 10; // Изменения не замечены

---

### Грязная проверка

    var data = {
        dirty: false,
        _raw: {key:"value"},
        get: function(key){
            return this._raw[key] 
        },
        set: function(key, newValue){
            this._raw[key] = newValue;
            this.dirty = true;
        }
    }

    funtion renderUI(data) {
        if(!data.dirty) return;
        data.dirty = false;
        ...
    }

---
# 

    funtion renderContactWidget(data) {
        if(!data.dirty) return;
        data.dirty = false;
        ...
    }

    funtion renderTimelineWidget(data) {
        if(!data.dirty) return;
        data.dirty = false;
        ...
    }    

    data.set('key', 'foo');

    renderContactWidget(data); // Есть обновление
    renderTimelineWidget(data); // Оппачки


---

### Сравнение Immutable объектов / списков  

    var map1 = I.Map({a:1, b:2, c:3});

--
    
    var map2 = map1.set('b', 50);
    console.log(I.is(map1, map2)); // false    

--
    
    var map3 = map2.set('b', 2);
    console.log(I.is(map1, map3)); // true


---
class: middle, center

# Плюшки

---

### Отсутсвие побочных эфектов

    module.exports = function updateAndPrintOut(updateFunc) {
      var data = {key: 'value'};
      updateFunc(data);
      console.log(data); // ?
    }    

---

### Простое клонирование объекта

    var map1 = Immutable.Map({a:1, b:2, c:3});
    var clone = map1;

---

class: middle, center

# Практически бесплатный undo/redo

---
class: center, middle

# .red[Как] пользоваться?

---
### Массивы

    var list1 = Immutable.List.of(1, 2);
    var list2 = list1.push(3, 4, 5);
    var list3 = list2.unshift(0);
    var list4 = list1.concat(list2, list3); 
    assert(list1.size === 2);
    assert(list2.size === 5);
    assert(list3.size === 6);
    assert(list4.size === 13);
    assert(list4.get(0) === 1);

---

### Объекты

    var map1 = Immutable.Map({a:1, b:2, c:3});
    var map2 = map1.set('b', 50);
    map1.get('b'); // 2
    map2.get('b'); // 50

---

### Принимает и возвращает обычные JS объекты

    var map1 = Immutable.Map({a:1, b:2, c:3, d:4});
    var map2 = Immutable.Map({c:10, a:20, t:30});
    var obj = {d:100, o:200, g:300};
    var map3 = map1.merge(map2, obj);

    console.log(map3.toJS()) 
    // { a: 20, b: 2, c: 10, d: 100, g: 300, o: 200, t: 30 }

---

### Многое другое

* Stack
* OrderedMap
* Set
* OrderedSet
* Record


---

### Групповые операции

    var list1 = Immutable.List.of(1,2,3);
    var list2 = list1.withMutations(function (list) {
      list.push(4).push(5).push(6);
    });
    assert(list1.size === 3);
    assert(list2.size === 6);

---
class: center, middle
name: almost-final
## Стоит пощупать в следующем проекте? 

---
template: almost-final

# .red[Да!] 

---
class: center, middle, nopages
# Вопросы?

Дмитрий Кунин

.no-bullets[
- http://dkun.in
- http://bit.ly/imm-js]

    </textarea>
    <script src="remark-latest.min.js">
    </script>
    <script>
 

      var slideshow = remark.create({ highlightLanguage: 'javascript'});

    </script>
  </body>
</html>